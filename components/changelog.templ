package components

import "html/template"

type ChangelogContainerArgs struct {
	CurrentURL     string
	HasMoreArticle bool
}

// Contains the article list and footer
templ ChangelogContainer(args ChangelogContainerArgs) {
	<main id="ocl-changelog-container" class="mx-4 sm:mx-0">
		{ children... }
		<div id="ocl-skeleton" class="hidden">
			<div class="animate-pulse w-full space-y-4 mt-12">
				<div class="w-3/4 h-9 rounded bg-black/10 dark:bg-white/10"></div>
				<div class="w-full h-5 rounded bg-black/10 dark:bg-white/10"></div>
				<div class="w-full h-32 rounded bg-black/10 dark:bg-white/10"></div>
			</div>
		</div>
	</main>
	if args.HasMoreArticle {
		@templ.FromGoHTML(infiniteScrollTemplate, args.CurrentURL)
	}
}

var infiniteScrollTemplate = template.Must(template.New("infiniteScrollTemplate").Parse(`
<script>
	const skeleton = document.getElementById("ocl-skeleton")
	const container = document.getElementById("ocl-changelog-container")
	const currentPageURL = new URL("{{ . }}")
	const params = currentPageURL.searchParams;
	let isLoadingNextPage = false
	let hasMore = true

	function loadStarted() {
		isLoadingNextPage = true
		skeleton.style.display = "block"
	}

	function loadEnded() {
		isLoadingNextPage = false
		skeleton.style.display = "none"
	}

	async function loadNextPage(url) {
		try {
			loadStarted()
			const currentPage = parseInt(params.get('page')) || 1;
			params.set('page', currentPage + 1);
 			// don't load full html page, only articles list
			params.set('articles', "true");

			const res = await fetch(currentPageURL)
			if (!res.ok || res.status === 204) {
				hasMore = false
			}
			const newArticles = await res.text()
			skeleton.insertAdjacentHTML('beforebegin', newArticles)
		} finally {
			loadEnded()
		}
	}

	window.addEventListener("scroll", () => {
		const bufferPx = 100 // start loading before reaching end of container
		const endReached = window.scrollY + window.innerHeight + bufferPx >= container.scrollHeight
		if(endReached && !isLoadingNextPage && hasMore){
			loadNextPage()
		}
	})
</script>
`,
))
